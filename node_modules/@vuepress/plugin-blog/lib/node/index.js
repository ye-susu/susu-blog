import{Logger as G,isFunction as C,isString as S,removeLeadingSlash as U,fromEntries as H,entries as z,addViteSsrNoExternal as W,getPageExcerpt as q}from"@vuepress/helper";import{watch as K}from"chokidar";import{createPage as D,preparePageComponent as Q,preparePageChunk as X,prepareRoutes as Y}from"vuepress/core";import{sanitizeFileName as Z,colors as f}from"vuepress/utils";const j="@vuepress/plugin-blog",l=new G(j),L=a=>encodeURI(a.split("/").map(Z).join("/")),B=(a,e,p,o,u)=>{const O=p.map(({key:n,getter:d,sorter:v=()=>-1,path:b="/:key/",layout:E="Layout",frontmatter:I=()=>({}),itemPath:m="/:key/:name/",itemLayout:k="Layout",itemFrontmatter:_=()=>({})})=>{u&&l.info(`Generating ${f.cyan(n)} category.
`);const M=C(m)?m:S(m)?g=>m.replace(/:key/g,o(n)).replace(/:name/g,o(g)):()=>null,c={},$=[];for(const g in a){if(b){const r=`${g}${U(b.replace(/:key/g,o(n)))}`;$.push({path:r,frontmatter:{...I(g),blog:{type:"category",key:n},layout:E}}),c[g]={path:L(r),map:{}}}else c[g]={path:"",map:{}};const{map:t}=c[g],h={};for(const r of a[g]){const i=d(r);for(const s of i){if(!(s in t)){const w=M(s);if(w){const R=`${g}${U(w)}`;$.push({path:R,frontmatter:{..._(s,g),blog:{type:"category",name:s,key:n},layout:k}}),t[s]={path:L(R),indexes:[]}}else t[s]={path:"",indexes:[]};h[s]=[]}h[s].push(r)}}for(const r in h)t[r].indexes=e.addItems(h[r].sort(v).map(({path:i})=>i));if(u){let r=`${n} category in locale ${g}:
`;for(const i in t){const{path:s,indexes:w}=t[i];r+=`${i}: found ${w.length} items${s?` in path: ${s}`:""}
`}l.info(r)}}return{key:n,categoryMap:c,pageOptions:$}});return{categoriesMap:H(O.map(({key:n,categoryMap:d})=>[n,d])),pageOptions:O.map(({pageOptions:n})=>n).flat()}},ee=a=>a.filter(({key:e,getter:p},o)=>!S(e)||!e?(l.error(`Invalid ${f.magenta("key")} option ${f.cyan(e)} in ${f.cyan(`category[${o}]`)}`),!1):C(p)?!0:(l.error(`Invalid ${f.magenta("getter")} option in "${f.cyan(`category[${o}]`)}", it should be a function!`),!1)),te=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogCategory)
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoriesMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ categoriesMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogCategory(categoriesMap);
  });
`,V=async(a,e)=>{await a.writeTemp("blog/category.js",`export const categoriesMap = ${JSON.stringify(e)};
${a.env.isDev?te:""}
`)},F=({pages:a},e)=>{const p={};return a.filter(o=>e(o)&&o.path.substring(o.pathLocale.length-1)!=="/404.html").forEach(o=>{(p[o.pathLocale]??=[]).push(o)}),p};class ae{store;constructor(){this.store=[]}addItem(e){const p=this.store.indexOf(e);return p===-1?(this.store.push(e),this.store.length-1):p}addItems(e){return e.map(p=>this.addItem(p))}clearItem(e){const p=this.store.indexOf(e);p!==-1&&(this.store[p]="")}toJSON(){return JSON.stringify(this.store)}}const oe=async(a,e)=>{await a.writeTemp("blog/store.js",`export const store = ${e.toJSON()};
`)},J=(a,e,p,o,u=!1)=>{const O=p.map(({key:n,sorter:d=()=>-1,filter:v=()=>!0,path:b="/:key/",layout:E="Layout",frontmatter:I=()=>({})})=>{u&&l.info(`Generating ${f.cyan(n)} type.
`);const m=[],k={};return z(a).forEach(([_,M])=>{const c=b?`${_}${U(b.replace(/:key/g,o(n)))}`:"",$=e.addItems(M.filter(v).sort(d).map(({path:g})=>g));c&&m.push({path:c,frontmatter:{...I(_),blog:{type:"type",key:n},layout:E}}),u&&l.info(`${n} type in locale ${_}: found ${$.length} items
`),k[_]={path:L(c),indexes:$}}),{key:n,typeMap:k,pageOptions:m}});return{typesMap:H(O.map(({key:n,typeMap:d})=>[n,d])),pageOptions:O.map(({pageOptions:n})=>n).flat()}},ne=a=>a.filter((e,p)=>{const{key:o}=e;return!S(o)||!o?(l.error(`Invalid ${f.magenta("key")} option ${f.cyan(o)} in ${f.cyan(`type[${p}]`)}`),!1):!0}),pe=`
if (import.meta.webpackHot) {
  import.meta.webpackHot.accept();
  if (__VUE_HMR_RUNTIME__.updateBlogType)
    __VUE_HMR_RUNTIME__.updateBlogType(typesMap);
}

if (import.meta.hot)
  import.meta.hot.accept(({ typesMap }) => {
    __VUE_HMR_RUNTIME__.updateBlogType(typesMap);
  });
`,A=async(a,e)=>{await a.writeTemp("blog/type.js",`export const typesMap = ${JSON.stringify(e)};
${a.env.isDev?pe:""}
`)},re=a=>e=>{e.env.isDebug&&l.info("Options:",a);const{getInfo:p=()=>({}),filter:o=t=>!!t.filePathRelative&&!t.frontmatter.home,metaScope:u="_blog",excerpt:O=!0,excerptSeparator:n="<!-- more -->",excerptLength:d=300,excerptFilter:v=o,isCustomElement:b=()=>!1,category:E=[],type:I=[],slugify:m=t=>t.replace(/[ _]/g,"-").replace(/[:?*|\\/<>]/g,"").toLowerCase()}=a,k=ee(E),_=ne(I),M=new ae;let c=[],$={},g={};return{name:j,define:()=>({__BLOG_META_SCOPE__:u}),extendsBundlerOptions:t=>{W(t,e,"@vuepress/helper")},extendsPage:t=>{O&&v(t)&&!t.data.excerpt&&(t.data.excerpt=q(e,t,{isCustomElement:b,separator:n,length:d})),o(t)&&(t.routeMeta={...u===""?p(t):{[u]:p(t)},...t.routeMeta})},onInitialized:async()=>{const t=F(e,o),h=B(t,M,k,m,e.env.isDebug),r=J(t,M,_,m,e.env.isDebug);await Promise.all([...h.pageOptions,...r.pageOptions].map(async i=>{if(e.pages.findIndex(s=>s.path===i.path)!==-1){l.warn("Overriding existing page:",i.path);const s=e.pages.findIndex(w=>w.path===i.path);e.pages.splice(s,1,await D(e,i))}e.pages.push(await D(e,i))})),c=[...h.pageOptions,...r.pageOptions].map(i=>i.path),$=h.categoriesMap,g=r.typesMap},onPrepared:async()=>{await oe(e,M),await V(e,$),await A(e,g),e.env.isDebug&&l.info("temp file generated")},onWatched:(t,h)=>{if("hotReload"in a?a.hotReload:e.env.isDebug){const r=K("pages/**/*.js",{cwd:e.dir.temp(),ignoreInitial:!0}),i=async()=>{const s=F(e,o),w=B(s,M,k,m,e.env.isDebug),R=J(s,M,_,m,e.env.isDebug),N=[...w.pageOptions,...R.pageOptions];await V(e,w.categoriesMap),await A(e,R.typesMap);const P=N.filter(y=>!c.includes(y.path)),T=c.filter(y=>N.every(x=>x.path!==y));P.length&&(e.env.isDebug&&l.info(`Adding new pages: ${P.map(({path:y})=>y).join(", ")}`),await Promise.all(P.map(async y=>{const x=await D(e,y);await Q(e,x),await X(e,x),e.pages.push(x)}))),T.length&&(e.env.isDebug&&l.info(`Removing following pages: ${T.join(", ")}`),T.forEach(y=>{e.pages.splice(e.pages.findIndex(({path:x})=>x===y),1)})),(T.length||P.length)&&await Y(e),c=N.map(y=>y.path),e.env.isDebug&&l.info("temp file updated")};r.on("add",()=>{i()}),r.on("change",()=>{i()}),r.on("unlink",()=>{i()}),h.push(r)}}}};export{re as blogPlugin};
//# sourceMappingURL=index.js.map
